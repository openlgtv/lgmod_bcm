#!/bin/sh
# NetCast setup rc.netcast script
if [ "$country_model" = "EU" ]
then
    echo "OpenLGTV_BCM-INFO: EU models do not have /mnt/widget.data mounted, so lets create 75MB tmpfs there..." | tee -a /var/log/OpenLGTV_BCM.log
    mount -t tmpfs ywedata /mnt/widget.data -o size=75M
fi

if [ ! -d /mnt/widget.data/samsung ]
then
    echo "OpenLGTV_BCM-INFO: creating /mnt/widget.data/samsung dir for Yahoo Widgets Engine data dir prepared for Samsung Widgets..." | tee -a /var/log/OpenLGTV_BCM.log
    mkdir -p /mnt/widget.data/samsung
fi

# Mount-binding NetCast services configs
if [ ! -h "/mnt/addon/browser/browser_application.txt" -a ! -h "/mnt/browser/browser_application.txt" -a ! -h "/mnt/addon/contents/config.xml" -a ! -h "/mnt/addon/bin/addon_mgr.bat" -a ! -h "/mnt/addon/ywe/config-oem.xml" -a ! -h "/mnt/addon/ywe/bin/konfabulator.sh" ]
then
    if [ ! -d /mnt/user/netcast ]
    then
	echo "OpenLGTV_BCM-INFO: creating /mnt/user/netcast dir for NetCast configs copy..." | tee -a /var/log/OpenLGTV_BCM.log
	mkdir -p /mnt/user/netcast
    fi
    if [ ! -d /mnt/user/ywe ]
    then
	echo "OpenLGTV_BCM-INFO: creating /mnt/user/ywe dir for Yahoo Widgets Engine configs copy..." | tee -a /var/log/OpenLGTV_BCM.log
	mkdir -p /mnt/user/ywe
    fi
    if [ ! -d /mnt/user/ywe/samsung ]
    then
	echo "OpenLGTV_BCM-INFO: creating /mnt/user/ywe/samsung dir for Yahoo Widgets Engine configs copy prepared for Samsung Widgets..." | tee -a /var/log/OpenLGTV_BCM.log
	mkdir -p /mnt/user/ywe/samsung
    fi
    if [ ! -f "/mnt/user/netcast/browser_application.txt" ]
    then
	if [ -f "/mnt/browser/browser_application.txt" ]
	then
	    echo "OpenLGTV_BCM-INFO: making browser config copy - /mnt/browser/browser_application.txt..." | tee -a /var/log/OpenLGTV_BCM.log
	    cp /mnt/browser/browser_application.txt /mnt/user/netcast/browser_application.txt
	fi
    fi
    if [ ! -f "/mnt/user/netcast/config.xml" ]
    then
	echo "OpenLGTV_BCM-INFO: making StageCraft config copy - /mnt/addon/contents/config.xml..." | tee -a /var/log/OpenLGTV_BCM.log
	cp /mnt/addon/contents/config.xml /mnt/user/netcast/config.xml
    fi
    if [ ! -f "/mnt/user/netcast/addon_mgr.bat" ]
    then
	echo "OpenLGTV_BCM-INFO: making Addon_Mgr config copy - /mnt/addon/bin/addon_mgr.bat..." | tee -a /var/log/OpenLGTV_BCM.log
	cp /mnt/addon/bin/addon_mgr.bat /mnt/user/netcast/addon_mgr.bat
    fi
    if [ ! -f "/mnt/user/ywe/config-oem.xml" ]
    then
	if [ -f "/mnt/addon/ywe/config-oem.xml" ]
	then
	    echo "OpenLGTV_BCM-INFO: making Yahoo Widgets Engine config copy - /mnt/addon/ywe/config-oem.xml..." | tee -a /var/log/OpenLGTV_BCM.log
	    cp /mnt/addon/ywe/config-oem.xml /mnt/user/ywe/config-oem.xml
	fi
    fi
    if [ ! -f "/mnt/user/ywe/samsung/config-oem.xml" ]
    then
	if [ -f "/mnt/user/ywe/config-oem.xml" ]
	then
	    echo "OpenLGTV_BCM-INFO: preparing Yahoo Widgets Engine config-oem.xml for Samsung Widgets in /mnt/addon/ywe/samsung/config-oem.xml..." | tee -a /var/log/OpenLGTV_BCM.log
	    cat /mnt/user/ywe/config-oem.xml | sed 's/.*fingerprints.*//g' | \
	        sed 's#\(<value key=\"gallery.gallery-url\">\).*\(</value>\)#\1http://127.0.0.1/ywe/update.cgi?yaction=\2#g' | \
	        sed 's#\(<group name="super-widget-settings"> \).*#\10748C0CBEF8CA6C8113AAEED10F6E1E1CBD3939C1A3982FED8D7CBF4207B3136041E7B26DFD35FD61AE3F6E113B2B5B5BE63AC5DEFE509D150A089E305AAA81889E1D08A64471F3F6BF039198219FF651E11F39A8BE9A44825D87FB39CBFD8D2E985B7E3C61DC6A24087DBF909EBC89B53A03684650704#g' > /mnt/user/ywe/samsung/config-oem.xml
	fi
    fi
    if [ ! -f "/mnt/user/ywe/konfabulator.sh" ]
    then
	if [ -f "/mnt/addon/ywe/bin/konfabulator.sh" ]
	then
	    echo "OpenLGTV_BCM-INFO: making Yahoo Widgets Engine startup script copy - /mnt/addon/ywe/bin/konfabulator.sh..." | tee -a /var/log/OpenLGTV_BCM.log
	    cp /mnt/addon/ywe/bin/konfabulator.sh /mnt/user/ywe/konfabulator.sh
	fi
    fi
    if [ -n '`grep "^export LD_LIBRARY_PATH=$KF_APP_PATH/lib:$LD_LIBRARY_PATH" /mnt/user/ywe/konfabulator.sh`' ]
    then
	echo "OpenLGTV_BCM-INFO: setting browser partition library path in Yahoo Widgets Engine startup script - /mnt/addon/ywe/bin/konfabulator.sh..." | tee -a /var/log/OpenLGTV_BCM.log
	sed -i -e 's#^export LD_LIBRARY_PATH=$KF_APP_PATH/lib:$LD_LIBRARY_PATH#export BROWSER=/mnt/browser\n\nexport LD_LIBRARY_PATH=$KF_APP_PATH/lib:$BROWSER/lib:$LD_LIBRARY_PATH#g' /mnt/user/ywe/konfabulator.sh
    fi
    if [ ! -f "/mnt/user/ywe/deviceid" ]
    then
	    deviceid=$RANDOM
	    echo "OpenLGTV_BCM-INFO: generating Yahoo Widgets Engine device id: $deviceid in /mnt/user/ywe/deviceid..." | tee -a /var/log/OpenLGTV_BCM.log
	    echo $deviceid > /mnt/user/ywe/deviceid
    fi
    if [ -f "/mnt/user/netcast/config.xml" -a -f "/mnt/user/netcast/addon_mgr.bat" ]
    then
	echo "OpenLGTV_BCM-INFO: setting links to NetCast configs on addon partition..." | tee -a /var/log/OpenLGTV_BCM.log
	mount --bind /mnt/user/netcast/config.xml              /mnt/addon/contents/config.xml
	mount --bind /mnt/user/netcast/addon_mgr.bat           /mnt/addon/bin/addon_mgr.bat
    fi
    if [ -f "/mnt/user/netcast/browser_application.txt" ]
    then
	echo "OpenLGTV_BCM-INFO: setting links to NetCast browser configs on browser partition..." | tee -a /var/log/OpenLGTV_BCM.log
	mount --bind /mnt/user/netcast/browser_application.txt /mnt/addon/browser/browser_application.txt
	mount --bind /mnt/user/netcast/browser_application.txt /mnt/browser/browser_application.txt
    fi
    if [ -f "/mnt/user/ywe/config-oem.xml" -a -f "/mnt/user/ywe/konfabulator.sh" ]
    then
	echo "OpenLGTV_BCM-INFO: setting links to Yahoo Widgets Engine configs on addon partition..." | tee -a /var/log/OpenLGTV_BCM.log
	mount --bind /mnt/user/ywe/config-oem.xml              /mnt/addon/ywe/config-oem.xml
	mount --bind /mnt/user/ywe/konfabulator.sh             /mnt/addon/ywe/bin/konfabulator.sh
    fi
    if [ ! -f "/mnt/user/ywe/samsung/konfabulator.sh" ]
    then
	echo "OpenLGTV_BCM-INFO: making copy of Yahoo Widgets Engine startup script for Samsung Widgets with proper engine and data paths - /mnt/user/ywe/samsung/konfabulator.sh..." | tee -a /var/log/OpenLGTV_BCM.log
	cat /mnt/user/ywe/konfabulator.sh | sed 's#^export KF_APP_PATH.*#export KF_APP_PATH=/mnt/ywe_s#g' | sed 's#^export KF_DATA_PATH.*#export KF_DATA_PATH=/mnt/widget.data/samsung#g' > /mnt/user/ywe/samsung/konfabulator.sh
	chmod +rx /mnt/user/ywe/samsung/konfabulator.sh
    fi
    if [ -z '`grep "^export KF_APP_PATH" /mnt/user/ywe/samsung/konfabulator.sh | grep "\/mnt\/ywe_s`' ]
    then
	echo "OpenLGTV_BCM-INFO: setting Yahoo Widgets Engine startup script for Samsung Widgets engine and data paths - /mnt/user/ywe/samsung/konfabulator.sh..." | tee -a /var/log/OpenLGTV_BCM.log
	sed -i -e 's#^export KF_APP_PATH.*#export KF_APP_PATH=/mnt/ywe_s#g' /mnt/user/ywe/samsung/konfabulator.sh
	sed -i -e 's#^export KF_DATA_PATH.*#export KF_DATA_PATH=/mnt/widget.data/samsung#g' /mnt/user/ywe/samsung/konfabulator.sh
    fi
    if [ -f "/mnt/user/ywe/samsung/config-oem.xml" -a -f "/mnt/user/ywe/samsung/konfabulator.sh" -a -d "/mnt/addon/ywe" ]
    then
	echo "OpenLGTV_BCM-INFO: mounting Yahoo Widgets Engine with configs for Samsung Widgets into /mnt/ywe_s..." | tee -a /var/log/OpenLGTV_BCM.log
	mount --bind /mnt/addon/ywe                            /mnt/ywe_s
	mount --bind /mnt/user/ywe/samsung/config-oem.xml      /mnt/ywe_s/config-oem.xml
	mount --bind /mnt/user/ywe/samsung/konfabulator.sh     /mnt/ywe_s/bin/konfabulator.sh
    fi
else
    echo "OpenLGTV_BCM-WARN: found modified addon or browser partition so you will have to check configs yourself..." | tee -a /var/log/OpenLGTV_BCM.log
fi
